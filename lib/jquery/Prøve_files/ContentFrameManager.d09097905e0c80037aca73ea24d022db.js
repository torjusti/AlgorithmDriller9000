Fronter.namespace('Fronter.View').ContentFrameManager=(function($){'use strict';var data,serviceUrl,container,contentframe,contentFrameTemplate,personalFrameData,contentChangeInspector,initialised=false,CONTENT_FRAME='contentframe',SELECTED='selected',_init=function(){contentChangeInspector=Fronter.View.ContentChangeInspector;contentFrameTemplate=$('#'+ CONTENT_FRAME).remove();container=$('#'+ CONTENT_FRAME+'-container');initialised=true;},_onPersonalFrameReady=function(_personalFrameData){personalFrameData=_personalFrameData;},isInitialised=function(){return initialised;},getSelectedContentFrame=function(){return $('.'+ CONTENT_FRAME+'.'+ SELECTED);},getSelectedContentFrameCustomerUrl=function(){return getSelectedContentFrameParams().navObj.itemCustomerUrl;},_deselectAllContentFrames=function(){var selected=getSelectedContentFrame();if(selected.length){selected.contentFrame('deselect');}},_personalFrameToolData=function(toolId){if(personalFrameData&&personalFrameData.personalTools&&personalFrameData.personalTools[toolId]){return personalFrameData.personalTools[toolId];}
return null;},_createBaseUrl=function(navObj){var tool,tmpBaseUrl,personalToolData;switch(navObj.itemType){case'room':return Fronter.Util.Rooms.getHref(navObj);case'tool':tool=Fronter.Util.PersonalTools.getById(navObj.itemId);if(tool&&tool.itemHref){tmpBaseUrl=tool.itemHref;}
personalToolData=_personalFrameToolData(navObj.itemId);if(personalToolData&&personalToolData.itemHref&&personalToolData.itemHref!==tmpBaseUrl){Fronter.Util.PersonalTools.set(personalToolData);tmpBaseUrl=personalFrameData.personalTools[navObj.itemId].itemHref;}
if(tmpBaseUrl){return tmpBaseUrl;}
break;}
return null;},_safeSelect=function(navObj,callback,clearDirty){contentChangeInspector.check({test:'isOkToCloseContentFrame',navObj:navObj,ifOk:function(options){if(clearDirty){contentChangeInspector.removeDirtyFrame(navObj);}
Fronter.Event.publish(Fronter.Event.Application.NAVIGATED,navObj);callback(options);}});},createContentFrameUid=function(navObj){var contentframeUid=CONTENT_FRAME+'-'+ navObj.itemType+'-'+ navObj.itemId;return contentframeUid;},getContentFrame=function(navObj){return $('#'+ createContentFrameUid(navObj));},stateEnabled=function(){var isStateEnabled=Fronter.Util.Config.get('stateEnabled');return!_(isStateEnabled).isNull()&&isStateEnabled;},contentFrameExists=function(navObj){return getContentFrame(navObj).length>0;},_getContentFrameContainer=function(){return $('#contentframe-container');},_selectContentFrame=function(contentframe,replayState){if(!contentframe.contentFrame('isSelected')){_deselectAllContentFrames();}
contentframe.contentFrame('select',replayState);},setServiceUrl=function(url){serviceUrl=url;},getServiceUrl=function(){return serviceUrl;},isContentFrameWidget=function(contentFrame){if($(contentFrame).data('contentFrame')){return true;}
return false;},isSelected=function(navObj){var contentFrame=getContentFrame(navObj);if(contentFrame.length&&isContentFrameWidget(contentFrame[0])){return contentFrame.contentFrame('isSelected');}
return false;},_createNewContentFrame=function(navObj){var contentFrameParams={'navObj':navObj,'baseUrl':_createBaseUrl(navObj)||navObj.itemHref,'selectOnCreate':true,'serviceUrl':serviceUrl,'container':_getContentFrameContainer(),'domId':createContentFrameUid(navObj)};if(!navObj.temp&&isSelected(navObj)){contentFrameParams.navObj.itemHref=contentFrameParams.baseUrl;}
_deselectAllContentFrames();contentFrameTemplate.clone().contentFrame(contentFrameParams);},closeContentFrame=function(navObj){var contentFrame=getContentFrame(navObj);if(!contentFrame.length){Fronter.Event.publish(Fronter.Event.ContentFrame.CLOSED,navObj);return;}
contentFrame.contentFrame('close');},getParams=function(contentframe){if(isContentFrameWidget(contentframe)){return contentframe.contentFrame('getParams');}
return false;},getContentFrameParams=function(navObj){var contentFrame=getContentFrame(navObj);return getParams(contentFrame);},getSelectedContentFrameParams=function(){var contentframe=getSelectedContentFrame();return getParams(contentframe);},isSameRoomAsSelected=function(navObj){var selectedParams=getSelectedContentFrameParams(),selectedNavObj=selectedParams.navObj||null;if(selectedNavObj&&navObj){return selectedNavObj.itemType==='room'&&selectedNavObj.itemType===navObj.itemType&&selectedNavObj.itemId===navObj.itemId;}
return false;},_showContentFrame=function(navObj){var contentframe=getContentFrame(navObj),selected=isSelected(navObj),sameRoom=isSameRoomAsSelected(navObj),clearDirty=true,forceUpdate,callback,action,baseUrl,update;if(navObj&&navObj.destroyCurrentFrame){getSelectedContentFrame().contentFrame('silentClose');delete navObj.destroyCurrentFrame;}
if((!sameRoom&&!stateEnabled())||!contentFrameExists(navObj)){Fronter.Event.publish(Fronter.Event.Application.NAVIGATED,navObj);_createNewContentFrame(navObj);return;}
forceUpdate=Fronter.Util.Dom.Link.getUrlParam('forceUpdate',navObj.itemHref);if(forceUpdate||navObj.temp){if(forceUpdate||navObj.temp.forceUpdate||navObj.temp.contentUrl){action=sameRoom?'updateContent':'update';}}
if(!action&&selected){action='loadBaseUrl';}
switch(action){case'updateContent':callback=function(options){_selectContentFrame(contentframe,false);contentframe.contentFrame('updateContent',navObj);};break;case'update':callback=function(options){_selectContentFrame(contentframe,false);contentframe.contentFrame('update',navObj);};break;case'loadBaseUrl':callback=function(options){contentframe.contentFrame('loadBaseUrl');};break;default:clearDirty=false;callback=function(){_selectContentFrame(contentframe);};if(!navObj.special){callback();return;}}
_safeSelect(navObj,callback,clearDirty);},loadContentFrame=function(navObj,reset){if(reset||!initialised){_init();}
_showContentFrame(navObj);};Fronter.Event.subscribe(Fronter.Event.PersonalFrame.READY,_onPersonalFrameReady);return{'getParams':getParams,'isSelected':isSelected,'stateEnabled':stateEnabled,'isInitialised':isInitialised,'setServiceUrl':setServiceUrl,'getServiceUrl':getServiceUrl,'getContentFrame':getContentFrame,'loadContentFrame':loadContentFrame,'closeContentFrame':closeContentFrame,'contentFrameExists':contentFrameExists,'isContentFrameWidget':isContentFrameWidget,'getContentFrameParams':getContentFrameParams,'createContentFrameUid':createContentFrameUid,'getSelectedContentFrame':getSelectedContentFrame,'getSelectedContentFrameParams':getSelectedContentFrameParams,'getSelectedContentFrameCustomerUrl':getSelectedContentFrameCustomerUrl};}(jQuery));