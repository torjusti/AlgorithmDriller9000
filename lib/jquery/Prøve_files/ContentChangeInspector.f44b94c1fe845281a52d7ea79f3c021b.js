Fronter.namespace('Fronter.View').ContentChangeInspector=(function($){'use strict';var dirtyFrames={},_targetElements=['input:not(.submit)','select','textarea','.widget-selector-panel'],_blackList=['.content-inspector-ignore','.navigational','.datatable:not(.editable)','.ui-datepicker','.ui-datepicker-header'],_buttons=['input[type=button].submit','input[type=submit].submit','button.submit'],getButtons=function(){return _buttons.toString();},getTargetElements=function(){return _targetElements.toString();},isInBlacklist=function(element){var $element=$(element);return $element.is(_blackList.toString())||$element.closest(_blackList.toString()).length;},checkOptions,contentFrameManager=Fronter.View.ContentFrameManager,answers={YES:'YES',NO:'NO',WAITING:'WAITING'},_getDomId=function(navObj){if(!navObj){return contentFrameManager.getSelectedContentFrameParams().domId;}
if(_(navObj).isNumber()||_(navObj).isString()){navObj=Fronter.Util.Rooms.navObjFromId(parseInt(navObj,10));}
return contentFrameManager.createContentFrameUid(navObj);},_addDirtyFrame=function(){var visibleContentFrameParams=contentFrameManager.getSelectedContentFrameParams();dirtyFrames[visibleContentFrameParams.domId]=visibleContentFrameParams;},_isFrameDirty=function(domId){return _(dirtyFrames).has(domId);},removeDirtyFrame=function(navObj){var domId=_getDomId(navObj);if(_isFrameDirty(domId)){delete dirtyFrames[domId];}},removeAllDirtyFrames=function(){dirtyFrames={};},dirtyFramesExist=function(){return _.size(dirtyFrames)>0;},currentFrameDirty=function(){var visibleContentFrameParams=contentFrameManager.getSelectedContentFrameParams();return _isFrameDirty(visibleContentFrameParams.domId);},getDirtyFrames=function(){return dirtyFrames;},_getRoomInfo=function(room){if(room&&room.navObj){return{'title':room.navObj.itemTitle};}
return null;},getDirtyFramesInfo=function(domId){var frames=[],roomInfo,checkList={};if(domId){if(!dirtyFrames[domId]){return dirtyFrames;}
checkList[domId]=dirtyFrames[domId];}else{checkList=dirtyFrames;}
_(checkList).each(function(frameParams,frameId){roomInfo=_getRoomInfo(dirtyFrames[frameId]);if(roomInfo.title){frames.push(roomInfo);}});return frames;},_askUserForDecision=function(options){Fronter.I18n.translate(['LOGOUT_UNSAVED_CHANGES','RELOAD_REQUIRED_UNSAVED_CHANGES','UNSAVED_CHANGES','YOU_HAVE_UNSAVED_CHANGES','YOU_HAVE_UNSAVED_CHANGES_FOLLOWING_TABS','SELECTED_ACTION_LOAD_TAB_UNSAVED_CHANGES','SELECTED_ACTION_RELOAD_FRONTER_LOSE_UNSAVED_CHANGES_FOLLOWING_TABS','DO_YOU_WANT_TO_DISCARD_CHANGES_AND_CONTINUE','DO_YOU_WANT_TO_DISCARD_CHANGES_AND_LOGOUT','OK','CANCEL'],function(translated){Fronter.Dialog.toggle({cache:false,id:'are_you_sure',style:'light',allowExit:false,title:translated[options.titleMessage],file:'Dialog/are_you_sure_html',mustache:{'description':{'beginMessage':translated[options.beginMessage],'endMessage':translated[options.endMessage],'rooms':options.dirtyFramesInfo}},buttons:{'ok':translated.OK,'cancel':translated.CANCEL}});});},_createDecision=function(overrides,sameFrame){var options={'titleMessage':'UNSAVED_CHANGES','endMessage':'DO_YOU_WANT_TO_DISCARD_CHANGES_AND_CONTINUE'},ignoreDirtyList=sameFrame||!overrides.dirtyFramesInfo||!overrides.dirtyFramesInfo.length,beginMessage=ignoreDirtyList?'YOU_HAVE_UNSAVED_CHANGES':'SELECTED_ACTION_LOAD_TAB_UNSAVED_CHANGES';_(options).extend(_(overrides).extend({'beginMessage':overrides.beginMessage?overrides.beginMessage:beginMessage,'dirtyFramesInfo':ignoreDirtyList?null:overrides.dirtyFramesInfo}));_askUserForDecision(options);return answers.WAITING;},_checkIfOkToLeaveRoom=function(closingNavObj,currentFrameParams){var closingFrameDomId=_getDomId(closingNavObj),selectedFrameDomId=currentFrameParams.domId,sameFrame=closingFrameDomId===selectedFrameDomId,dirtyFramesInfo=getDirtyFramesInfo(closingFrameDomId);if(_isFrameDirty(closingFrameDomId)){return _createDecision({'dirtyFramesInfo':dirtyFramesInfo},sameFrame);}
return answers.YES;},_isOkToLeaveRoom=function(targetNavObj,currentFrameParams){var shouldCheck=!contentFrameManager.stateEnabled()||(currentFrameParams.navObj&&currentFrameParams.navObj.itemSpecial);if(shouldCheck){return _checkIfOkToLeaveRoom(targetNavObj,currentFrameParams);}
return answers.YES;},_isOkToSwitchRoomTool=function(targetNavObj,currentFrameParams){return _checkIfOkToLeaveRoom(targetNavObj,currentFrameParams);},_isOkToCloseContentFrame=function(targetNavObj,currentFrameParams){return _checkIfOkToLeaveRoom(targetNavObj,currentFrameParams);},_isOkToReload=function(){if(dirtyFramesExist()){return _createDecision({titleMessage:'RELOAD_REQUIRED_UNSAVED_CHANGES',beginMessage:'SELECTED_ACTION_RELOAD_FRONTER_LOSE_UNSAVED_CHANGES_FOLLOWING_TABS',endMessage:'DO_YOU_WANT_TO_DISCARD_CHANGES_AND_CONTINUE',dirtyFramesInfo:getDirtyFramesInfo()});}
return answers.YES;},_isOkToSwitchUser=function(){var dirtyFramesInfo;if(dirtyFramesExist()){dirtyFramesInfo=getDirtyFramesInfo();return _createDecision({titleMessage:'UNSAVED_CHANGES',beginMessage:'YOU_HAVE_UNSAVED_CHANGES_FOLLOWING_TABS',endMessage:'DO_YOU_WANT_TO_DISCARD_CHANGES_AND_CONTINUE',dirtyFramesInfo:dirtyFramesInfo});}
return answers.YES;},_isOkToLogout=function(){var dirtyFramesInfo;if(dirtyFramesExist()){dirtyFramesInfo=getDirtyFramesInfo();return _createDecision({'titleMessage':'LOGOUT_UNSAVED_CHANGES','endMessage':'DO_YOU_WANT_TO_DISCARD_CHANGES_AND_LOGOUT','dirtyFramesInfo':dirtyFramesInfo});}
return answers.YES;},_onButtonPressed=function(role){switch(role){case'ok':removeDirtyFrame(contentFrameManager.getSelectedContentFrameParams().navObj);if(_(checkOptions.ifOk).isFunction()){checkOptions.ifOk.call(top,checkOptions.options);}
break;case'cancel':if(_(checkOptions.ifCancel).isFunction()){checkOptions.ifCancel.call(top,checkOptions.options);}
break;}
Fronter.Event.unsubscribe(Fronter.Event.Dialog.BUTTON_PRESSED,_onButtonPressed);},check=function(options){var tests={'isOkToSwitchRoomTool':_isOkToSwitchRoomTool,'isOkToLeaveRoom':_isOkToLeaveRoom,'isOkToCloseContentFrame':_isOkToCloseContentFrame,'isOkToReload':_isOkToReload,'isOkToLogout':_isOkToLogout,'isOkToSwitchUser':_isOkToSwitchUser},currentFrameParams=contentFrameManager.getSelectedContentFrameParams(),answer=tests[options.test].call(window,options.navObj,currentFrameParams);switch(answer){case answers.YES:options.ifOk.call(window,options.options);break;case answers.NO:if(_(options.ifCancel).isFunction()){options.ifCancel.call(window,options.options);}
break;case answers.WAITING:checkOptions=options;Fronter.Event.subscribe(Fronter.Event.Dialog.BUTTON_PRESSED,_onButtonPressed);break;}},_onClosed=function(navObj){removeDirtyFrame(navObj);},_onLoaded=function(navObj){if(!contentFrameManager.stateEnabled()){removeAllDirtyFrames();}else{removeDirtyFrame(navObj);}},_onContentInputChanged=function(element){if(isInBlacklist(element)){return;}
_addDirtyFrame();},_onContentInputSubmit=function(navObj){removeDirtyFrame(navObj);},_onContentInputCancel=function(navObj){_onContentInputSubmit(navObj);};$(function(){Fronter.Event.batchSubscribe([{'event':Fronter.Event.ContentFrame.CLOSED,'callbacks':_onClosed},{'event':Fronter.Event.ContentFrame.LOADED,'callbacks':_onLoaded},{'event':Fronter.Event.Content.Input.CHANGED,'callbacks':_onContentInputChanged},{'event':Fronter.Event.Content.Input.SUBMIT,'callbacks':_onContentInputSubmit},{'event':Fronter.Event.Content.Input.CANCEL,'callbacks':_onContentInputCancel}]);});return{'check':check,'getDirtyFrames':getDirtyFrames,'currentFrameDirty':currentFrameDirty,'getDirtyFramesInfo':getDirtyFramesInfo,'dirtyFramesExist':dirtyFramesExist,'removeDirtyFrame':removeDirtyFrame,'getButtons':getButtons,'isInBlacklist':isInBlacklist,'getTargetElements':getTargetElements};}(jQuery));